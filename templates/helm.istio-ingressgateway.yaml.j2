---
name: istio-ingressgateway
{% if istio_revision %}
revision: {{ istio_revision }}
{% endif %}
global:
  hub: {{ istio_repo }}
  tag: {{ istio_ver }}{{ istio_flavor }}
labels:
  istio: ingressgateway
  app: istio-ingressgateway
  topology.istio.io/network: {{ network }}
#  proxy.istio.io/config: '{"discoveryAddress" : "istiod-main.istio-system.svc:15012" }'
##env:
##  ISTIO_META_ROUTER_MODE: sni-dnat
##  ISTIO_META_REQUESTED_NETWORK_VIEW: ${_context}
service:
{% if azure_enabled %}
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: "false"
{% endif %}
{% if aws_enabled %}
  annotations:
    external-dns.alpha.kubernetes.io/hostname: "ingress-gateway.{{ network }}.soloio.vincentjorgensen.com"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: tcp
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/healthz/ready"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "15021"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: http
    service.beta.kubernetes.io/aws-load-balancer-name: "ingress-gateway-{{ network }}"
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: instance
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
{%-   if https_enabled %}
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: arn:aws:acm:us-west-2:103739863673:certificate/64893fb2-f334-4c85-8f05-c0c42a637e19
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "{{ https_port }}"
    service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: "ELBSecurityPolicy-TLS13-1-2-2021-06"
{%-   endif %}
  extralabels:
    target-workload: gateway
{% endif %}

  type: LoadBalancer
replicaCount: {{ ingress_size }}
autoscaling:
    minReplicas: {{ ingress_size }}
    maxReplicas: {{ ingress_size }}
#affinity:
#  podAntiAffinity:
#    preferredDuringSchedulingIgnoredDuringExecution:
#    - podAffinityTerm:
#        labelSelector:
#          matchExpressions:
#          - key: istio
#            operator: In
#            values:
#            - ingressgateway-${_revision}
#        topologyKey: topology.kubernetes.io/zone
#      weight: 100

##podAnnotations:
##  inject.istio.io/templates: "gateway,custom_ingress"
...
